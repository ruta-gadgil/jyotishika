name: Deploy Backend to AWS Lambda

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: production
        type: choice
        options:
          - production
          - staging

env:
  AWS_REGION: ap-south-1
  SAM_TEMPLATE: backend/template.yaml

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run smoke tests
        working-directory: backend
        run: |
          pytest tests/test_smoke.py -v
        env:
          EPHE_PATH: ./ephe
          TESTING: true

  deploy:
    needs: test  # Only deploy if tests pass
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: SAM Build with Docker
        working-directory: backend
        run: |
          sam build \
            --use-container \
            --cached \
            --parallel \
            --build-image public.ecr.aws/sam/build-python3.11:latest
        env:
          DOCKER_BUILDKIT: 1

      - name: SAM Deploy
        working-directory: backend
        run: |
          sam deploy \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name samved-api \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              Environment=${{ github.event.inputs.environment || 'production' }} \
              DatabaseUrl="${{ secrets.DATABASE_URL }}" \
              GoogleClientId="${{ secrets.GOOGLE_CLIENT_ID }}" \
              GoogleClientSecret="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              SecretKey="${{ secrets.SECRET_KEY }}" \
              AllowedOrigins="${{ secrets.ALLOWED_ORIGINS || 'https://app.samved.ai' }}" \
              AppBaseUrl="${{ secrets.APP_BASE_URL || 'https://api.samved.ai' }}" \
              FrontendBaseUrl="${{ secrets.FRONTEND_BASE_URL || 'https://app.samved.ai' }}"

      - name: Get API URL
        id: api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name samved-api \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "### Deployed to: $API_URL" >> $GITHUB_STEP_SUMMARY

      - name: Health check
        run: |
          sleep 10
          curl -f "${{ steps.api-url.outputs.api_url }}/healthz" || exit 1
      
      - name: Post-deployment smoke tests
        run: |
          # Test OAuth endpoint is accessible
          echo "Testing OAuth login endpoint..."
          OAUTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "${{ steps.api-url.outputs.api_url }}/auth/google/login")
          if [ "$OAUTH_STATUS" != "302" ] && [ "$OAUTH_STATUS" != "500" ]; then
            echo "❌ OAuth login endpoint returned unexpected status: $OAUTH_STATUS"
            exit 1
          fi
          echo "✅ OAuth login endpoint accessible"
          
          # Test robots.txt exists
          echo "Testing robots.txt..."
          curl -f "${{ steps.api-url.outputs.api_url }}/robots.txt" || exit 1
          echo "✅ robots.txt accessible"
          
          echo "### ✅ All post-deployment checks passed" >> $GITHUB_STEP_SUMMARY
