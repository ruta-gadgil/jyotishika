#!/bin/bash
# Pre-commit hook to prevent committing secrets
# Install: git config core.hooksPath .githooks

set -e

echo "üîç Running pre-commit security checks..."

# Forbidden patterns that indicate secrets
FORBIDDEN_PATTERNS=(
  "GOCSPX-"
  "AIza"
  "sk-"
  "ghp_"
  "gho_"
  "AKIA"
  "[0-9]{12}"  # AWS Account IDs (12 digits)
)

# Check staged files for secrets
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No files staged"
  exit 0
fi

echo "üìù Checking ${#STAGED_FILES[@]} staged files..."

FOUND_SECRET=false

for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
  if git diff --cached | grep -i -E "$pattern" >/dev/null 2>&1; then
    echo "‚ùå Error: Potential secret detected: $pattern"
    echo "   Please remove secrets before committing"
    FOUND_SECRET=true
  fi
done

# Check for common secret file patterns
for file in $STAGED_FILES; do
  case "$file" in
    *.env|*.env.local|*.env.*.local|*secrets*|*credentials*)
      echo "‚ö†Ô∏è  Warning: Attempting to commit sensitive file: $file"
      echo "   Are you sure this should be committed?"
      ;;
  esac
done

if [ "$FOUND_SECRET" = true ]; then
  echo ""
  echo "üõë Commit blocked: Secrets detected"
  echo "   Remove secrets and try again"
  exit 1
fi

echo "‚úÖ Pre-commit checks passed"
exit 0
